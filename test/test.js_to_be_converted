'use strict'

// this is a hack to get rid of the ECONNRESET errors
// but it does not work :-(
const http = require('http')
http.globalAgent.maxSockets = Infinity

const supertest = require('supertest')
const should = require('should')
const appPassFile = require('../appPass.json')

const app = require('../server.js')

global.describe('hooks', function () {
  global.before(function () {
    app.inject({ url: '127.0.0.1:4001' }, function (err) {
      if (err) throw err
      console.log('Server running at:', app.info.uri)
    })
  })
})

// does not work: error
// Uncaught TypeError: Cannot read property 'should' of undefined
// const server = supertest(app)

// const server = supertest.agent('http://127.0.0.1:4001')
const server = supertest('http://127.0.0.1:4001')

// skipping because if not, ECONNRESET happens ???!!!

global.describe('/exportView', function () {
  global.it('should return text/x-csv for view v_ap and ApArtId 206200', function (done) {
    server
      .get('/exportView/csv/view=v_ap/filename=test/206200')
      .end((err, res) => {
        if (err) throw err
        res.status.should.equal(200)
        res.type.should.equal('text/x-csv')
        done()
      })
  })
})

global.describe('/exportViewWhereIdIn', function () {
  global.it('should return text/x-csv for view v_ap and ApId 900 and 206200', function (done) {
    server
      .get('/exportViewWhereIdIn/csv/view=v_ap/idName=ApArtId/idListe=900,206200/filename=test')
      .end((err, res) => {
        if (err) throw err
        res.status.should.equal(200)
        res.type.should.equal('text/x-csv')
        done()
      })
  })
})
